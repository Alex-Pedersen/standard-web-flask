{% extends 'forums/base.html' %}

{% block forum_content %}
    <div class="forum">
        <div class="breadcrumbs">
            <a href="{{ url_for('forums') }}">Forums</a> &rarr;
            {{ forum.name }}
        </div>
        {{ pages() }}
        <h4>{{ forum.name }}</h4>
        <table class="forum-topic-table">
            {% for topic in topics %}
                <tr class="{% if topic.sticky %}sticky{% endif %}">
                    <td class="forum-cell">
                        <img class="acitivity-icon" src="{{ url_for('static', filename='images/forums/active_topic.png') }}">
                        <div class="forum-info">
                            {% if topic.sticky %}Sticky:{% endif %}
                            <a class="name" href="{{ topic.url }}">{{ topic.name }}</a>
                            <div class="description">
                                <a href="{{ url_for('player', username=topic.user.username) }}">
                                    {{ topic.user.username|face_thumb }} {{ topic.user.username }}
                                </a> -
                                <abbr class="timeago" title="{{ topic.created | iso_date }}">{{ topic.created }}</abbr>
                                {% if topic.post_count > 20 %}
                                    -
                                    {% for page in range(1, (topic.post_count // 20) + 2) %}
                                        {% if page > 1 %}
                                            <a href="{{ url_for('forum_topic', topic_id=topic.id, p=page) }}">{{ page }}</a>
                                        {% else %}
                                            <a href="{{ url_for('forum_topic', topic_id=topic.id) }}">{{ page }}</a>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="count">
                            <b>{{ topic.post_count }}</b> {{ 'post' if topic.post_count == 1 else 'posts' }}
                        </div>
                        <div class="count">
                            <b>{{ topic.views }}</b> {{ 'view' if topic.views == 1 else 'views' }}
                        </div>
                    </td>
                    <td class="last-post-cell">
                        {% with last_post = topic.last_post, last_post_user = last_post.user %}
                        <div>
                            <b>Last post:</b> <a href="{{ last_post.url }}"><abbr class="timeago" title="{{ last_post.created | iso_date }}">{{ last_post.created }}</abbr></a>
                        </div>
                        <div>
                            {{ last_post_user.username|face_thumb }} <a href="{{ url_for('player', username=last_post_user.username) }}">{{ last_post_user.username }}</a>
                        </div>
                        {% endwith %}
                    </td>
                </tr>
            {% endfor %}
        </table>
        {{ pages() }}
    </div>
{% endblock %}

{% macro pages() %}
    <div class="pages">
        {% if forum.topic_count > page_size %}
            <b>Pages:</b>
            {% for p in range(1, (forum.topic_count // page_size) + 2) %}

                {% if p == page %}
                    <span>{{ p }}</span>
                {% elif p != 1 %}
                    <a href="{{ url_for('forum', forum_id=forum.id, p=p) }}">{{ p }}</a>
                {% else %}
                    <a href="{{ url_for('forum', forum_id=forum.id) }}">{{ p }}</a>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
{%- endmacro %}